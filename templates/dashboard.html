<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard - SmartQueue</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<header>
    <div class="logo">SmartQueue Hospital - Admin</div>
    <div class="header-actions">
        <button onclick="confirmLogout()" class="logout-btn">Logout</button>
    </div>
</header>

<h2 style="text-align:center; margin-top:30px;">
    Admin Dashboard
</h2>

<div class="dashboard-cards">
    <div class="status-card">
        <h3>Waiting</h3>
        <h2 id="waitingCount">{{ waiting }}</h2>
    </div>

    <div class="status-card">
        <h3>Called</h3>
        <h2 id="calledCount">{{ called }}</h2>
    </div>

    <div class="status-card">
        <h3>Completed</h3>
        <h2 id="completedCount">{{ completed }}</h2>
    </div>
</div>

<div class="table-wrapper">
<table>
<tr>
    <th>Token</th>
    <th>Name</th>
    <th>Age</th>
    <th>Gender</th>
    <th>Mobile</th>
    <th>Check-In Time</th>
    <th>Status</th>
    <th>Action</th>
    <th>Print</th>
</tr>

{% for p in patients %}
<tr>
    <td>#{{ p.id }}</td>
    <td>{{ p.name }}</td>
    <td>{{ p.age }}</td>
    <td>{{ p.gender }}</td>
    <td>{{ p.mobile }}</td>
    <td>{{ p.checkin_time }}</td>

    <td>
        <span class="badge 
            {% if p.status == 'Waiting' %}waiting
            {% elif p.status == 'Called' %}called
            {% else %}completed
            {% endif %}">
            {{ p.status }}
        </span>
    </td>

    <td>
        {% if p.status == "Waiting" %}
            <button onclick="callPatient({{ p.id }}, '{{ p.mobile }}')" 
                    class="action-btn call-btn">Call</button>
        {% elif p.status == "Called" %}
            <button onclick="completePatient({{ p.id }})" 
                    class="action-btn complete-btn">Complete</button>
        {% else %}
            -
        {% endif %}
    </td>

    <td>
        {% if p.status != "Waiting" %}
            <a href="/print/{{ p.id }}" target="_blank" class="print-btn">
                ðŸ–¨ Print
            </a>
        {% else %}
            -
        {% endif %}
    </td>
</tr>
{% endfor %}
</table>
</div>

<footer>
    Â© 2026 SmartQueue Hospital
</footer>

<script>

/* ===== Logout ===== */
function confirmLogout() {
    if (confirm("Are you sure you want to logout?")) {
        window.location.href = "/logout";
    }
}

/* ===== WhatsApp Open ===== */
function sendWhatsApp(mobile, token) {

    let number = mobile.replace(/\D/g, '');

    if (!number.startsWith("91")) {
        number = "91" + number;
    }

    let message = "Token number " + token +
                  " is now called. Please proceed to consultation room.";

    let url = "https://wa.me/" + number +
              "?text=" + encodeURIComponent(message);

    window.open(url, "_blank");
}

/* ===== Call Patient ===== */
function callPatient(id, mobile) {

    fetch(`/call/${id}`, { method: "POST" })
    .then(response => response.json())
    .then(data => {

        if (data.success) {

            sendWhatsApp(mobile, id);

            // reload after 1 second
            setTimeout(function(){
                location.reload();
            }, 1000);
        }
    });
}

/* ===== Complete Patient ===== */
function completePatient(id) {

    fetch(`/complete/${id}`, { method: "POST" })
    .then(response => response.json())
    .then(data => {

        if (data.success) {
            location.reload();
        }
    });
}

/* ===== Auto Refresh Every 6 Seconds ===== */
setInterval(function(){
    location.reload();
}, 6000);

</script>

</body>
</html>
