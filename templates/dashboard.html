<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard - SmartQueue</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<!-- ================= HEADER ================= -->

<header>
    <div class="logo">SmartQueue Hospital - Admin</div>

    <div class="header-actions">
        <button onclick="confirmLogout()" class="logout-btn">Logout</button>
    </div>
</header>

<h2 style="text-align:center; margin-top:30px;">
    Admin Dashboard
</h2>

<!-- ================= STATUS CARDS ================= -->

<div class="dashboard-cards">

    <div class="status-card">
        <h3>Waiting</h3>
        <h2 id="waitingCount">{{ waiting }}</h2>
    </div>

    <div class="status-card">
        <h3>Called</h3>
        <h2 id="calledCount">{{ called }}</h2>
    </div>

    <div class="status-card">
        <h3>Completed</h3>
        <h2 id="completedCount">{{ completed }}</h2>
    </div>

</div>

<!-- ================= PATIENT TABLE ================= -->

<table>
    <thead>
        <tr>
            <th>Token</th>
            <th>Name</th>
            <th>Age</th>
            <th>Gender</th>
            <th>Mobile</th>
            <th>Check-In Time</th>
            <th>Status</th>
            <th>Action</th>
            <th>Print</th>
        </tr>
    </thead>

    <tbody id="patientTableBody">
    {% for p in patients %}
    <tr>
        <td>#{{ p.id }}</td>
        <td>{{ p.name }}</td>
        <td>{{ p.age }}</td>
        <td>{{ p.gender }}</td>
        <td>{{ p.mobile }}</td>
        <td>{{ p.checkin_time }}</td>

        <td>
            <span class="badge 
                {% if p.status == 'Waiting' %}waiting
                {% elif p.status == 'Called' %}called
                {% else %}completed
                {% endif %}">
                {{ p.status }}
            </span>
        </td>

        <td>
            {% if p.status == "Waiting" %}
                <button onclick="callPatient({{ p.id }}, '{{ p.mobile }}')" 
                        class="action-btn call-btn">Call</button>

            {% elif p.status == "Called" %}
                <button onclick="completePatient({{ p.id }})" 
                        class="action-btn complete-btn">Complete</button>

            {% else %}
                -
            {% endif %}
        </td>

        <td>
            {% if p.status != "Waiting" %}
                <a href="/print/{{ p.id }}"
                   target="_blank"
                   class="print-btn">
                   ðŸ–¨ Print
                </a>
            {% else %}
                -
            {% endif %}
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<footer>
    Â© 2026 SmartQueue Hospital
</footer>

<!-- ================= JAVASCRIPT ================= -->

<script>

/* ===== Logout Confirmation ===== */

function confirmLogout() {
    if (confirm("Are you sure you want to logout?")) {
        window.location.href = "/logout";
    }
}

/* ===== Update Counters ===== */

function updateCounters(oldStatus, newStatus) {

    let waiting = document.getElementById("waitingCount");
    let called = document.getElementById("calledCount");
    let completed = document.getElementById("completedCount");

    if (oldStatus === "Waiting") waiting.innerText--;
    if (oldStatus === "Called") called.innerText--;

    if (newStatus === "Called") called.innerText++;
    if (newStatus === "Completed") completed.innerText++;
}

/* ===== DIRECT WHATSAPP OPEN ===== */

function sendWhatsApp(mobile, token) {

    let formattedMobile = mobile.replace(/\D/g, '');

    if (!formattedMobile.startsWith("91")) {
        formattedMobile = "91" + formattedMobile;
    }

    let message = "Token number " + token +
                  " is now called. Please proceed to consultation room.";

    let isMobile = /iPhone|Android/i.test(navigator.userAgent);

    let url;

    if (isMobile) {
        url = "whatsapp://send?phone=" + formattedMobile +
              "&text=" + encodeURIComponent(message);
    } else {
        url = "https://web.whatsapp.com/send?phone=" + formattedMobile +
              "&text=" + encodeURIComponent(message);
    }

    window.location.href = url;
}

/* ===== Call Patient ===== */

function callPatient(id, mobile) {

    fetch(`/call/${id}`, { method: "POST" })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            sendWhatsApp(mobile, id);
        }
    });
}

/* ===== Complete Patient ===== */

function completePatient(id) {

    fetch(`/complete/${id}`, { method: "POST" })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log("Patient Completed");
        }
    });
}

/* ===== LIVE UPDATE WITHOUT RELOAD ===== */

setInterval(function(){

    fetch("/live-data")
    .then(response => response.json())
    .then(data => {

        if (data.logout) {
            window.location.href = "/admin";
            return;
        }

        let tableBody = "";
        let waiting = 0;
        let called = 0;
        let completed = 0;

        data.forEach(p => {

            if (p.status === "Waiting") waiting++;
            if (p.status === "Called") called++;
            if (p.status === "Completed") completed++;

            let actionButton = "-";

            if (p.status === "Waiting") {
                actionButton = `<button onclick="callPatient(${p.id}, '${p.mobile}')" 
                                 class="action-btn call-btn">Call</button>`;
            } else if (p.status === "Called") {
                actionButton = `<button onclick="completePatient(${p.id})" 
                                 class="action-btn complete-btn">Complete</button>`;
            }

            let printButton = "-";
            if (p.status !== "Waiting") {
                printButton = `<a href="/print/${p.id}" target="_blank"
                                class="print-btn">ðŸ–¨ Print</a>`;
            }

            tableBody += `
                <tr>
                    <td>#${p.id}</td>
                    <td>${p.name}</td>
                    <td>${p.age}</td>
                    <td>${p.gender}</td>
                    <td>${p.mobile}</td>
                    <td>${p.checkin_time}</td>
                    <td><span class="badge ${p.status.toLowerCase()}">${p.status}</span></td>
                    <td>${actionButton}</td>
                    <td>${printButton}</td>
                </tr>
            `;
        });

        document.getElementById("patientTableBody").innerHTML = tableBody;

        document.getElementById("waitingCount").innerText = waiting;
        document.getElementById("calledCount").innerText = called;
        document.getElementById("completedCount").innerText = completed;

    });

}, 2000);

</script>

</body>
</html>
